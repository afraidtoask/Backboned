/*
 * jQuery hashchange event - v1.3 - 7/21/2010
 * http://benalman.com/projects/jquery-hashchange-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function($,e,b){var c="hashchange",h=document,f,g=$.event.special,i=h.documentMode,d="on"+c in e&&(i===b||i>7);function a(j){j=j||location.href;return"#"+j.replace(/^[^#]*#?(.*)$/,"$1")}$.fn[c]=function(j){return j?this.bind(c,j):this.trigger(c)};$.fn[c].delay=50;g[c]=$.extend(g[c],{setup:function(){if(d){return false}$(f.start)},teardown:function(){if(d){return false}$(f.stop)}});f=(function(){var j={},p,m=a(),k=function(q){return q},l=k,o=k;j.start=function(){p||n()};j.stop=function(){p&&clearTimeout(p);p=b};function n(){var r=a(),q=o(m);if(r!==m){l(m=r,q);$(e).trigger(c)}else{if(q!==m){location.href=location.href.replace(/#.*/,"")+q}}p=setTimeout(n,$.fn[c].delay)}$.browser.msie&&!d&&(function(){var q,r;j.start=function(){if(!q){r=$.fn[c].src;r=r&&r+a();q=$('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){r||l(a());n()}).attr("src",r||"javascript:0").insertAfter("body")[0].contentWindow;h.onpropertychange=function(){try{if(event.propertyName==="title"){q.document.title=h.title}}catch(s){}}}};j.stop=k;o=function(){return a(q.location.href)};l=function(v,s){var u=q.document,t=$.fn[c].domain;if(v!==s){u.title=h.title;u.open();t&&u.write('<script>document.domain="'+t+'"<\/script>');u.close();q.location.hash=v}}})();return j})()})(jQuery,this);

/*
 * Backboned Theme - v0.1 - 7/2011
 * http://www.emanuel-kluge.de/
 * 
 * Copyright (c) 2011 Emanuel Kluge
 * Released under GPL:
 * http://www.opensource.org/licenses/gpl-license.php
**/

(function($){window.site.js.wordpress=Backbone.Model.extend();window.site.js.wordpressCollection=Backbone.Collection.extend({model:window.site.js.wordpress,months:{'01':'Januar','02':'Februar','03':'M&auml;rz','04':'April','05':'Mai','06':'Juni','07':'Juli','08':'August','09':'September','10':'Oktober','11':'November','12':'Dezember'},initialize:function(){_.bindAll(this,'check');this.bind('refresh',this.check)},check:function(){var a=this.view.options.type,model=a?this.toJSON()[0][a]:this;if(model.length){this.view.trigger('refresh')}else{if(a=='comments'){this.view.noComments()}else{window.location.hash='!/404/'}}},returnMonth:function(a){return this.months[a]},nicedate:function(a){var b=a.substr(0,a.indexOf(' ')).split('-');return b[2].replace(/^0/,'')+'. '+this.returnMonth(b[1])+' '+b[0]}});window.site.js.wordpressController=Backbone.Controller.extend({routes:{'':'init','!/index/:page/':'index','!/post/:slug/:id/':'post','!/page/:slug/':'page','!/category/:slug/:id/:page/':'category','!/archive/:month/:year/:page/':'archive','!/404/':'error','*misc':'redirect404'},removeComments:function(){$(window).hashchange(function(){$('#comments, #commentform').empty();$('h2.comment_headline').remove()})},initialize:function(){_.bindAll(this,'removeComments');this.bind('route:post',this.removeComments);var a=this;this.bind('all',function(){window.scrollTo(0,0);a.navPagesApp.checkCurrent()});this.navPagesApp=new window.site.js.navView({navId:'pages'});this.navCategoriesApp=new window.site.js.navView({navId:'categories',title:'Kategorien'});this.navArchivesApp=new window.site.js.navView({navId:'archives',title:'Archiv'});this.navBookmarksApp=new window.site.js.navView({navId:'bookmarks',title:'Blogroll'});if(site.twtr_info){this.twitterCollection=new window.site.js.wordpressCollection;this.twitterCollection.url='http://twitter.com/statuses/user_timeline.json?screen_name='+site.twtr_info.name+'&count='+site.twtr_info.count+'&callback=?';this.twitterWidget=site.twtr_info&&new window.site.js.twitterView({model:this.twitterCollection.fetch()})}this.theTitle=new window.site.js.titleView();this.theFooter=new window.site.js.footerView();Backbone.history.start()},init:function(){window.location.hash='!/index/1/'},index:function(a){var b=new window.site.js.wordpressCollection;b.url='?_escaped_fragment_=/index/'+a+'/&output_type=JSON';var c=new window.site.js.postsView({model:b.fetch(),controller:this}),pagination=new window.site.js.paginationView({page:a,count:site.post_count,slug:'#!/index/'})},post:function(a,b){var c=new window.site.js.wordpressCollection,commentCollection=new window.site.js.wordpressCollection,commentFormCollection=new window.site.js.wordpressCollection({post_id:b,post_url:site.base_url+'#!/post/'+a+'/'+b+'/'});c.url='?_escaped_fragment_=/post/'+a+'/'+b+'/&output_type=JSON';commentCollection.url=c.url;var d=new window.site.js.singlePostView({model:c.fetch(),type:'post'}),comments=new window.site.js.commentsView({model:commentCollection.fetch(),type:'comments'}),commentForm=new window.site.js.commentFormView({model:commentFormCollection,commentView:comments,postView:d})},page:function(a){var b=new window.site.js.wordpressCollection;b.url='?_escaped_fragment_=/page/'+a+'/&output_type=JSON';var c=new window.site.js.pageView({model:b.fetch()});this.navPagesApp.checkCurrent(a)},category:function(a,b,c){var d=new window.site.js.wordpressCollection;d.url='?_escaped_fragment_=/category/'+a+'/'+b+'/'+c+'/&output_type=JSON';var e=new window.site.js.postsView({model:d.fetch()}),pagination=new window.site.js.paginationView({page:c,category_id:b,slug:'#!/category/'+a+'/'+b+'/'})},archive:function(a,b,c){var d=new window.site.js.wordpressCollection;d.url='?_escaped_fragment_=/archive/'+a+'/'+b+'/'+c+'/&output_type=JSON';var e=new window.site.js.postsView({model:d.fetch()}),pagination=new window.site.js.paginationView({page:c,month:a,year:b,slug:'#!/archive/'+a+'/'+b+'/'})},error:function(){var a=new window.site.js.wordpressCollection({title:'404',content:'Leider wurde nichts gefunden. Zurück zur <a href="#!/index/1/">Startseite</a>'});var b=new window.site.js.errorView({model:a}).render()},redirect404:function(){window.location.hash='!/404/'}});window.site.js.postsView=Backbone.View.extend({el:$('#posts'),template:$('#post-template'),initialize:function(){_.bindAll(this,'addPost');this.bind('refresh',this.addPost);this.model.view=this},render:function(b,c){var d=this;d.el.append(d.template.tmpl(b,{nicedate:function(a){return d.model.nicedate(a)},commentCount:function(a){return a==0?'Keine Kommentare':a==1?'Ein Kommentar':a+' Kommentare'}}));if(c==this.model.length){this.el.fadeIn('slow')}return this},addPost:function(){this.el.empty().hide();_.each(this.model.toJSON(),function(a,b){this.render(a,++b)},this)}});window.site.js.singlePostView=Backbone.View.extend({el:$('#posts'),template:$('#single-post-template'),initialize:function(){_.bindAll(this,'render');this.el.empty().hide();this.model.view=this;this.bind('refresh',this.renderCategories)},render:function(c){var d=this;$('#pagination').empty();d.el.append(d.template.tmpl(c,{nicedate:function(a){return d.model.nicedate(a)},displayCategories:function(a){var b=['<p><small>',/,\s/.test(a)?'Kategorien: ':'Kategorie: ',a,'</small></p>'].join('');return a&&b}})).fadeIn('slow');return this},renderCategories:function(){var a=[],obj=this.model.toJSON()[0]['cats'],merged;for(i in obj){if(obj.hasOwnProperty(i)){a.push('<a href="#!/category/'+obj[i].slug+'/'+obj[i].term_id+'/1/">'+obj[i].name+'</a>')}}merged=_.extend(this.model.toJSON()[0]['post'][0],{categories:a.join(', ')});this.render(merged)}});window.site.js.pageView=Backbone.View.extend({el:$('#posts'),template:$('#page-template'),initialize:function(){_.bindAll(this,'render');this.el.empty().hide();this.model.view=this;this.bind('refresh',this.render)},render:function(){var b=this;$('#pagination').empty();b.el.append(b.template.tmpl(this.model.toJSON()[0],{nicedate:function(a){return b.model.nicedate(a)}})).fadeIn('slow');return this}});window.site.js.commentsView=Backbone.View.extend({el:$('#comments'),template:$('#comment-template'),events:{'click .comment_delete':'deleteComment'},initialize:function(){_.bindAll(this,'addComments');this.model.view=this;this.bind('refresh',this.addComments)},render:function(b,c){var d=this,len=this.model.toJSON()[0]['comments'].length,post_title=this.model.toJSON()[0]['post'][0]['post_title'],headline=(len==1?'Ein Kommentar zu ':len+' Kommentare zu "')+post_title+'"';d.el.append(d.template.tmpl(b,{nicedate:function(a){return d.model.nicedate(a)},linkify:function(a){if(b.comment_author_url){return'<a href="'+b.comment_author_url+'">'+a+'</a>'}else{return a}},deleteButton:function(a){if(site.logged_in){return'<span class="comment_delete ID-'+b.comment_ID+'">Löschen</span>'}else{return''}}}));if(c==len){if(this.el.prev()[0].tagName.toLowerCase()=='h2'){this.el.prev().text(headline)}else{this.el.before('<h2 class="comment_headline">'+headline+'</h2>')}this.el.fadeIn('slow')}return this},deleteComment:function(b){var c=this,Id=b.target.className.substr(b.target.className.indexOf('-')+1);if(site.logged_in){$.ajax({url:site.base_url,data:'?_escaped_fragment_=/comment_delete/'+Id+'/',success:function(a){c.model.fetch()}})}},addComments:function(){this.el.empty().hide();_.each(this.model.toJSON()[0]['comments'],function(a,b){this.render(a,++b)},this)},noComments:function(){this.el.before('<h2 class="comment_headline">Zu diesem Beitrag gibt es noch keine Kommentare.</h2>')}});window.site.js.commentFormView=Backbone.View.extend({el:$('#commentform_wrap'),template:null,get_template:function(b){var c=this;$.ajax({url:site.base_url,data:'_escaped_fragment_=/commentform/',success:function(a){c.template=$(a);b.apply(c)}})},events:{'click #submit':'submitForm','click .logout':'logout'},initialize:function(){_.bindAll(this,'submitForm');this.get_template(this.render)},render:function(){this.el.hide().html(this.template.tmpl(this.model.toJSON()[0])).fadeIn('slow');return this},submitForm:function(c){c.preventDefault();var d=this,$form=$(c.target.form),$data=$form.serializeArray();$.post('wp-comments-post.php',$data,function(a,b){if(b==='success'){d.options.commentView.model.fetch();c.target.form.reset()}})},logout:function(d){d.preventDefault();var e=this;$.get(d.target.href,function(a,b){if(b==='success'){var c=$('#wpadminbar');site.logged_in=false;e.get_template(e.render);e.options.commentView.model.fetch();if(c.length){c.remove();$.each($('head style'),function(){$(this).html(function(){return!!/html\s\{\smargin-top:\s28px\s!important;\s\}/.test($(this).text())&&''})})}}})}});window.site.js.errorView=Backbone.View.extend({el:$('#posts'),template:$('#error-template'),initialize:function(){$('#pagination').empty()},render:function(){$('#pagination, #commentform_wrap').empty();this.el.hide().html(this.template.tmpl(this.model.toJSON()[0])).fadeIn('slow');return this}});window.site.js.paginationView=Backbone.View.extend({el:$('#pagination'),initialize:function(){this.el.hide();this.render()},render:function(){var b,current=parseInt(this.options.page),items=[],j=1;if(current>1){items.push('<span><a href="'+this.options.slug+(current-1)+'/">&laquo;</a></span>')}if(!_.isUndefined(this.options.count)){b=Math.ceil(this.options.count/10)}else{if(!_.isUndefined(this.options.category_id)){b=_.detect(site.categories,function(a){return a.cat_id==this.options.category_id},this)}else if(!_.isUndefined(this.options.year)&&!_.isUndefined(this.options.month)){var c=new RegExp('.('+this.options.month+').('+this.options.year+').','gi');b=_.detect(site.archives,function(a){return c.test(a.slug)},this)}b=Math.ceil(b.count/10)}for(var i=0;i<b;i++){if(j==current){items.push('<span class="current">'+j+'</span>')}else if(j!=current){if(i==0||i==1||i==b-2||i==b-1){items.push('<span><a href="'+this.options.slug+j+'/">'+j+'</a></span>')}if(current>3&&i==current-2&&i<b-2||current<b-2&&i==current&&i>1){items.push('<span><a href="'+this.options.slug+j+'/">'+j+'</a></span>')}if(current>4&&i==current-3||i==current+1&&current<b-3){items.push('<span>&hellip;</span>')}}j++}if(current<b){items.push('<span><a href="'+this.options.slug+(current+1)+'/">&raquo;</a></span>')}this.el.html(items.join('')).fadeIn('slow');return this},});window.site.js.titleView=Backbone.View.extend({el:$('#title'),template:$('#title-template'),initialize:function(){this.render()},render:function(){this.el.html(this.template.tmpl(site.title,{beautify:function(a){var a=a.split(''),len=a.length,steps=Math.floor(95/len),titleArr=[];for(var i=0;i<len;i++){var j=(i+1)*steps,rgbCode=j+','+j+','+j,item=a[i];titleArr.push(!/\s/.test(item)?'<span style="color:rgb('+rgbCode+')">'+item+'</span>':' ')}return titleArr.join('')}}));return this}});window.site.js.navView=Backbone.View.extend({template:$('#nav-item-template'),initialize:function(){this.el=$('#'+this.options.navId);this.addItems()},render:function(a){this.el.append(this.template.tmpl(a));return this},addItems:function(){if('title'in this.options){this.el.before($('<h4 />',{text:this.options.title}))}_.each(site[this.options.navId],function(a,b){this.render(a)},this)},checkCurrent:function(){var a=new RegExp(location.hash,'g'),$elem=this.el.find('a');$.each($elem,function(){this.className=a.test(this.href)?'current':''})}});window.site.js.twitterView=Backbone.View.extend({el:$('#twitter_widget'),template:$('#twitter-template'),initialize:function(){_.bindAll(this,'addTweet');this.model.view=this;this.bind('refresh',this.addTweet)},render:function(c,d){var e=this;this.el.append(e.template.tmpl(c,{tweetify:function(a){var a=a.replace(/http:\/\/\S+/g,'<a href="$&" target="_blank">$&</a>'),a=a.replace(/\s(@)(\w+)/g,' @<a href="http://twitter.com/$2" target="_blank">$2</a>'),a=a.replace(/\s(#)(\w+)/g,' #<a href="http://search.twitter.com/search?q=%23$2" target="_blank">$2</a>');return a},relativeTime:function(a){var b=a.split(' '),time_value=b[1]+' '+b[2]+', '+b[5]+' '+b[3],parsed_date=Date.parse(time_value),relative_to=(arguments.length>1)?arguments[1]:new Date(),delta=parseInt((relative_to.getTime()-parsed_date)/1000),delta=delta+(relative_to.getTimezoneOffset()*60);if(delta<60){return'less than a minute ago'}else if(delta<120){return'about a minute ago'}else if(delta<(60*60)){return(parseInt(delta/60)).toString()+' minutes ago'}else if(delta<(120*60)){return'about an hour ago'}else if(delta<(24*60*60)){return'about '+(parseInt(delta/3600)).toString()+' hours ago'}else if(delta<(48*60*60)){return'1 day ago'}else{return(parseInt(delta/86400)).toString()+' days ago'}}}));if(d==this.model.length){this.el.fadeIn('slow')}return this},addTweet:function(){var c=['<h4>','<a href="http://twitter.com/'+site.twtr_info.name+'">','Neueste Tweets von '+site.twtr_info.name,'</a>','</h4>'].join('');this.el.hide().before(c);_.each(this.model.toJSON(),function(a,b){this.render(a,++b)},this)}});window.site.js.footerView=Backbone.View.extend({el:$('#footer'),initialize:function(){this.render()},render:function(){var a=new Date(),content=['<p class="footer_left">&copy; <a href="#!'+site.title.home+'">'+site.title.name+'</a> &middot; '+a.getFullYear()+'</p>','<p class="footer_right">&quot;<strong>Backboned</strong>&quot;-Theme by <a href="http://www.emanuel-kluge.de/">Emanuel Kluge</a></p>'].join('');this.el.html(content);return this}})})(jQuery);